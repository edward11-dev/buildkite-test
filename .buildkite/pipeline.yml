env:
  NODE_ENV: "test"
  
steps:
  - group: "ğŸ” Code Quality"
    steps:
      - label: "ğŸ“¦ Install Dependencies"
        key: "install"
        command: |
          echo "--- ğŸ–¥ï¸ Agent Environment Info"
          hostname
          whoami
          pwd
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "--- ğŸ” Before npm ci"
          ls -la
          echo "package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"
          echo "package-lock.json exists: $(test -f package-lock.json && echo 'YES' || echo 'NO')"
          echo "--- ğŸ“¦ Installing dependencies"
          echo "Current directory files:"
          ls -la | grep -E "(package|node_modules)"
          if [ -f package-lock.json ]; then
            echo "âœ… package-lock.json found, using npm ci"
            npm ci --verbose || (echo "âŒ npm ci failed!" && exit 1)
          else
            echo "âš ï¸ No package-lock.json found, using npm install"
            npm install --verbose || (echo "âŒ npm install failed!" && exit 1)
            echo "ğŸ“„ package-lock.json should now be created"
            ls -la package-lock.json || echo "package-lock.json still missing"
          fi
          echo "--- ğŸ” After installation - checking what was installed"
          echo "node_modules exists: $(test -d node_modules && echo 'YES' || echo 'NO')"
          if [ ! -d node_modules ]; then
            echo "âŒ CRITICAL: node_modules was not created!"
            echo "Installation failed but didn't exit. Forcing failure."
            exit 1
          fi
          if [ -d node_modules ]; then
            echo "node_modules size: $(du -sh node_modules)"
            echo "Contents of node_modules/.bin:"
            ls -la node_modules/.bin/ | head -20
            echo "--- Checking specific packages"
            ls node_modules/.bin/ | grep -E "(jest|eslint)" || echo "Jest/ESLint binaries not found"
          else
            echo "âŒ node_modules directory was not created!"
          fi
          echo "--- npm list output"
          npm list --depth=0 || echo "npm list failed"
        agents:
          queue: "default"

      - label: "ğŸ§¹ Lint Code"
        key: "lint"
        depends_on: "install"
        command: |
          echo "--- ğŸ” Full Agent Environment Debug"
          echo "Current working directory: $(pwd)"
          echo "Home directory: $HOME"
          echo "Build directory contents:"
          ls -la
          echo "--- Node.js Environment"
          echo "Node path: $(which node)"
          echo "npm path: $(which npm)"
          echo "npm global packages:"
          npm list -g --depth=0 2>/dev/null | head -5
          echo "--- Checking node_modules"
          if [ -d "node_modules" ]; then
            echo "node_modules exists, size: $(du -sh node_modules)"
            ls -la node_modules/.bin/ | head -10
            echo "ESLint in .bin:"
            ls -la node_modules/.bin/ | grep eslint || echo "No ESLint binary found"
          else
            echo "âŒ node_modules directory not found!"
          fi
          echo "--- Package Dependencies"
          cat package.json | grep -A 10 -B 2 eslint
          echo "--- npm list eslint"
          npm list eslint || echo "ESLint not in dependencies"
          echo "--- Trying different ESLint methods"
          which eslint || echo "eslint not in global PATH"
          npx eslint --version || echo "npx eslint failed"
          echo "--- File permissions check"
          ls -la node_modules/.bin/eslint 2>/dev/null || echo "ESLint binary doesn't exist"
          echo "--- ğŸ§¹ Running ESLint"
          npm run lint
        agents:
          queue: "default"

      - label: "ğŸ§ª Run Tests"  
        key: "test"
        depends_on: "install"
        command: |
          echo "--- ğŸ” Checking Working Directory & Dependencies"
          pwd
          ls -la
          echo "--- ğŸ” Looking for node_modules from install step"
          find . -name "node_modules" -type d 2>/dev/null || echo "No node_modules found in current directory tree"
          echo "--- ğŸ” Installing dependencies in this step"
          npm install --verbose
          echo "--- ğŸ” Verifying installation"
          ls -la node_modules/.bin/ | grep jest || echo "Jest not installed"
          npm test
        agents:
          queue: "default"
        artifact_paths:
          - "coverage/**/*"

  - wait: "~"

  - group: "ğŸ³ Build & Security"
    steps:
      - label: "ğŸ³ Build Docker Image"
        key: "build"
        command: |
          echo "--- ğŸ³ Building Docker image"
          export IMAGE_TAG="buildkite-test:$$BUILDKITE_COMMIT"
          docker build --target production -t $$IMAGE_TAG .
          
          echo "--- ğŸ·ï¸ Tagging image"
          docker tag $$IMAGE_TAG buildkite-test:latest
          
          echo "--- ğŸ’¾ Saving image for later steps"
          docker save $$IMAGE_TAG | gzip > image.tar.gz
        agents:
          queue: "default"
        artifact_paths:
          - "image.tar.gz"

      - label: "ğŸ”’ Security Scan"
        key: "security"
        depends_on: "build"
        command: |
          echo "--- ğŸ” Downloading Docker image artifact"
          pwd
          ls -la
          echo "--- ğŸ“¥ Downloading artifact from previous step"
          if ! buildkite-agent artifact download "image.tar.gz" .; then
            echo "âŒ CRITICAL ERROR: Failed to download Docker image artifact!"
            echo "âŒ This indicates the build step failed or didn't upload the artifact."
            exit 1
          fi
          ls -la image.tar.gz || echo "image.tar.gz not found after download"
          
          if [ -f "image.tar.gz" ]; then
            echo "--- ğŸ”’ Loading Docker image from artifact"
            docker load < image.tar.gz
          else
            echo "âŒ CRITICAL ERROR: Docker image artifact not found!"
            echo "âŒ The build step must have failed to create/upload the image."
            echo "âŒ Cannot proceed with security scan without the built image."
            exit 1
          fi
          
          echo "--- ğŸ” Running security scan (Trivy)"
          # Install Trivy if not available
          if ! command -v trivy &> /dev/null; then
            echo "Installing Trivy..."
            if [[ "$(uname)" == "Darwin" ]]; then
              brew install aquasecurity/trivy/trivy
            else
              wget -qO- https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
            fi
          fi
          
          # Scan the image
          echo "--- ğŸ” Available Docker images:"
          docker images | grep buildkite-test || echo "No buildkite-test images found"
          echo "--- ğŸ” Scanning image: buildkite-test:$BUILDKITE_COMMIT"
          trivy image --exit-code 0 --no-progress --format table buildkite-test:$BUILDKITE_COMMIT
        agents:
          queue: "default"
        allow_dependency_failure: true

  - wait: "~"

  - group: "ğŸš€ Deploy"
    steps:
      - label: "ğŸš€ Deploy to Staging"
        key: "deploy-staging"
        command: |
          echo "--- ğŸ“¥ Downloading Docker image artifact"
          if ! buildkite-agent artifact download "image.tar.gz" .; then
            echo "âŒ CRITICAL ERROR: Failed to download Docker image artifact!"
            echo "âŒ This indicates the build step failed or didn't upload the artifact."
            exit 1
          fi
          ls -la image.tar.gz || echo "image.tar.gz not found after download"
          
          echo "--- ğŸš€ Deploying to staging environment"
          if [ -f "image.tar.gz" ]; then
            docker load < image.tar.gz
          else
            echo "âŒ CRITICAL ERROR: Docker image artifact not found!"
            echo "âŒ Cannot deploy to staging without the built and tested image."
            echo "âŒ Please check the build and security scan steps for failures."
            exit 1
          fi
          
          # Stop existing container if running
          docker stop buildkite-test-staging 2>/dev/null || true
          docker rm buildkite-test-staging 2>/dev/null || true
          
          # Run new container
          docker run -d \
            --name buildkite-test-staging \
            -p 3001:3000 \
            -e NODE_ENV=staging \
            buildkite-test:$$BUILDKITE_COMMIT
          
          echo "--- â³ Waiting for application to start"
          sleep 10
          
          echo "--- ğŸ¥ Health check"
          curl -f http://localhost:3001/health || exit 1
          
          echo "âœ… Staging deployment successful!"
          echo "ğŸŒ Application available at: http://localhost:3001"
        agents:
          queue: "default"

      - block: "ğŸ¯ Deploy to Production?"
        prompt: "Deploy to production environment?"
        if: build.branch == "main"

      - label: "ğŸŒŸ Deploy to Production"
        key: "deploy-production"
        depends_on: "deploy-staging"
        command: |
          echo "--- ğŸ“¥ Downloading Docker image artifact"
          if ! buildkite-agent artifact download "image.tar.gz" .; then
            echo "âŒ CRITICAL ERROR: Failed to download Docker image artifact!"
            echo "âŒ This indicates the build step failed or didn't upload the artifact."
            exit 1
          fi
          ls -la image.tar.gz || echo "image.tar.gz not found after download"
          
          echo "--- ğŸŒŸ Deploying to production environment"
          if [ -f "image.tar.gz" ]; then
            docker load < image.tar.gz
          else
            echo "âŒ CRITICAL ERROR: Docker image artifact not found!"
            echo "âŒ Cannot deploy to production without the built and tested image."
            echo "âŒ Please check the build, security, and staging steps for failures."
            exit 1
          fi
          
          # Stop existing container if running
          docker stop buildkite-test-prod 2>/dev/null || true
          docker rm buildkite-test-prod 2>/dev/null || true
          
          # Run new container
          docker run -d \
            --name buildkite-test-prod \
            -p 3000:3000 \
            -e NODE_ENV=production \
            buildkite-test:$$BUILDKITE_COMMIT
          
          echo "--- â³ Waiting for application to start"
          sleep 10
          
          echo "--- ğŸ¥ Health check"
          curl -f http://localhost:3000/health || exit 1
          
          echo "âœ… Production deployment successful!"
          echo "ğŸŒ Application available at: http://localhost:3000"
        agents:
          queue: "default"
        if: build.branch == "main"

  - group: "ğŸ“Š Post-Deploy"
    steps:
      - label: "ğŸ§ª Integration Tests"
        key: "integration-tests"
        depends_on: "deploy-staging"
        command: |
          echo "--- ğŸ§ª Running integration tests against staging"
          
          # Basic API tests
          echo "Testing home endpoint..."
          curl -f http://localhost:3001/ | jq .
          
          echo "Testing users endpoint..."
          curl -f http://localhost:3001/api/users | jq .
          
          echo "Testing user creation..."
          curl -f -X POST http://localhost:3001/api/users \
            -H "Content-Type: application/json" \
            -d '{"name":"Test User","email":"test@example.com"}' | jq .
          
          echo "âœ… Integration tests passed!"
        agents:
          queue: "default"

      - label: "ğŸ“ˆ Performance Test"
        key: "performance"
        depends_on: "deploy-staging"
        command: |
          echo "--- ğŸ“ˆ Running basic performance test"
          
          # Install curl and time if needed
          which curl || (echo "curl not found" && exit 1)
          
          echo "Running 10 concurrent requests..."
          for i in {1..10}; do
            (curl -s http://localhost:3001/health > /dev/null && echo "Request $i: OK") &
          done
          wait
          
          echo "âœ… Performance test completed!"
        agents:
          queue: "default"
        soft_fail: true